## 0.1 多変量正規分布の性質

確率変数 \( \mathbf{x} \) が多変量正規分布 \( N(\boldsymbol{\mu}, \Sigma) \) に従うとする。ただし、

\[
\mathbf{x} = \begin{pmatrix} x_1 \\ x_2 \end{pmatrix}, \quad \boldsymbol{\mu} = \begin{pmatrix} \mu_1 \\ \mu_2 \end{pmatrix}
\]

\[
\Sigma = \begin{pmatrix} \Sigma_{11} & \Sigma_{12} \\ \Sigma_{21} & \Sigma_{22} \end{pmatrix}, \quad \Sigma_{ij} = \text{Cov}(x_i, x_j) \quad (i,j=1,2) \quad \Sigma_{ji} = \Sigma'_{ij}
\]

であり、記号 \( A' \) は行列 \( A \) の転置行列を表す。

この時、以下のことがいえる：

1. 確率変数 \( \mathbf{x} \) の線形変換 \( A\mathbf{x} + \mathbf{b} \) は多変量正規分布 \( N(A\boldsymbol{\mu} + \mathbf{b}, A\Sigma A') \) に従う。

2. 周辺分布 
   \[
   p(x_1) = \int p(\mathbf{x}) \, dx_2, \quad p(x_2) = \int p(\mathbf{x}) \, dx_1
   \]
   はそれぞれ多変量正規分布 \( N(\mu_1, \Sigma_{11}) \)、\( N(\mu_2, \Sigma_{22}) \) に従う。

3. 条件付き分布 
   \[
   p(x_1 | x_2)
   \]
   は多変量正規分布 
   \[
   N\left( \mu_1 + \Sigma_{12} \Sigma_{22}^{-1}(x_2 - \mu_2), \, \Sigma_{11} - \Sigma_{12} \Sigma_{22}^{-1} \Sigma_{21} \right)
   \]
   に従う。

4. 確率変数 \( \mathbf{z} \) が多変量正規分布 \( N(\boldsymbol{\mu}_z, \Sigma_z) \) に、確率変数 \( \mathbf{w} \) が多変量正規分布 \( N(\boldsymbol{\mu}_w, \Sigma_w) \) に独立に従うとき、二変数の和は多変量正規分布 
   \[
   N(\boldsymbol{\mu}_z + \boldsymbol{\mu}_w, \, \Sigma_z + \Sigma_w)
   \]
   に従う（再生性）。

線形ガウス型モデルやガウス過程においては、これらの好ましい性質によって効率的に計算を行える。


## 0.2 逆行列公式

行列 \( V, H, R \) をそれぞれ次のように定義します：

- \( V \): \( k \) 次正則行列
- \( H \): \( l \times k \) 行列
- \( R \): \( l \) 次正則行列

この時、以下のことがいえる（ウッドベリーの公式）：

1. 
   \[
   (V^{-1} + H' R^{-1} H)^{-1} = V - VH' (R + HVH')^{-1} HV
   \]

2. 
   \[
   (V^{-1} + H' R^{-1} H)^{-1} H' R^{-1} = VH' (R + HVH')^{-1}
   \]

1.1 データ同化の基本概念
データ同化とは、観測データを取り込みシミュレーションの精度を向上させることを目標とする統計的手法である。本資料では逐次的に状態も推定を行う状態空間モデルに関して説明する。

時系列データの分析で真っ先に思い浮かぶものとして、ARモデルをはじめとするBox-Jenkinsモデルがある。状態空間モデルはそれらを更に一般化したものであり、計算コストと引き換えにより柔軟なモデル構築を可能とするほか欠損を含んだデータセットへの適応などの長所を持つ。

状態空間モデルでは、求めたい時系列データである状態 {xt}t
 を直接には観測できないが {xt}t
 に何かしらの変換が加えられた時系列データ {yt}t
 は観測が可能である、という際に観測データが得られた下での状態の条件付き分布の導出によって推測を行う。Bayesの定理を活用することで観測が増加するにつれ逐次的に条件付き分布を計算できる。

状態と観測の推移は、適当な関数 \( f_t \)、\( g_t \) およびシステムノイズ \( v_t \)、観測ノイズ \( w_t \) を用いて以下の一般形で表せる：

1. 状態モデル：
   \[
   \mathbf{x}_t = f_t(\mathbf{x}_{t-1}, v_t)
   \]

2. 観測モデル：
   \[
   \mathbf{y}_t = h_t(\mathbf{x}_t, w_t)
   \]

グラフィカルモデリングをみると、システムモデルと観測モデルで2種類の矢印があることがわかる。更新式は、矢印の先の記号は矢印の根元にある記号にノイズを交えた関数で表されることを意味している。このことを条件付き分布の形で考えるのが以下の式である。省略されている各々のノイズは条件付き分布のパラメータとして含まれる。

1. システムモデル：
   \[
   \mathbf{x}_t \sim p(\mathbf{x}_t | \mathbf{x}_{t-1})
   \]

2. 観測モデル：
   \[
   \mathbf{y}_t \sim p(\mathbf{y}_t | \mathbf{x}_t)
   \]

条件付き分布の形式で考えることにより、逐次的に分布 \( p(\mathbf{x}_s | \mathbf{y}_{1:t}) \) を用いて状態の推定ができる。

## 1.2 予測・フィルタ・平滑化

条件付き分布を考えるとき、問題となるのが「どの時点までの観測データを持っているときに、いつの時点の状態について知りたいか」である。条件付き分布 \( p(\mathbf{x}_s | \mathbf{y}_{1:t}) \) の導出は添え字 \( s, t \) の大小関係によって3つの手続きへ分類できる：

1. **予測** (\( s > t \))：手元の観測よりも先の状態を推定する。特に \( s = t + 1 \) の時を「一期先予測」と呼び、予測分布からフィルタ分布への逐次更新で利用する。

2. **フィルタ** (\( s = t \))：手元の観測を用いて現時刻での状態を推定する。

3. **平滑化** (\( s < t \))：関心がある状態よりも先の観測を手元に置いたうえで推定をする。

同時刻の状態 \( \mathbf{x}_t \) に関しては、当然情報が多いほど精度の高い推測ができる。状態空間モデルでは、下図のように予測・フィルタを繰り返し観測が得られる度に情報の更新を行い、十分な観測が得られたのちに平滑化を行う。具体的な手続きについては、各手法と合わせて紹介する。

## 2.1 カルマンフィルタ

カルマンフィルタとは、一期先予測・フィルタの計算を交互に行う計算法である。

### 前提条件

1. システムモデル、観測モデルが線形である。
2. システムノイズ、観測ノイズがガウス分布に従う。
3. 初期フィルタ分布がガウス分布、もしくは初期一期先予測分布がガウス分布である。

と仮定すると、以降の予測分布、フィルタ分布はすべてガウス分布となる。ガウス分布は平均と共分散行列で指定ができる。したがって、両者の更新を計算すれば状態の確率分布が定まる。

### システムモデル・観測モデル

システムモデルおよび観測モデルは次のように定まる：

\[
\mathbf{x}_t = F_t \mathbf{x}_{t-1} + G_t v_t \quad \text{(システムモデル)}
\]

\[
\mathbf{y}_t = H_t \mathbf{x}_t + w_t \quad \text{(観測モデル)}
\]

ただし、システムノイズ・観測ノイズは次のように定義される：

\[
v_t \sim N(0, Q_t)
\]

\[
w_t \sim N(0, R_t)
\]

つまり、パラメータは係数行列および共分散行列からなる。

これらのモデルを条件付き分布として解釈すると、

\[
\mathbf{x}_t \sim p(\mathbf{x}_t | \mathbf{x}_{t-1}) = N(F_t \mathbf{x}_{t-1}, G_t Q_t G_t') \quad \text{(システムモデル)}
\]

\[
\mathbf{y}_t \sim p(\mathbf{y}_t | \mathbf{x}_t) = N(H_t \mathbf{x}_t, R_t) \quad \text{(観測モデル)}
\]

となる。要は、所与の値に線形変換した値を中心とする正規分布であり、分散共分散行列がシステムノイズ・観測ノイズ由来の値となっている。

### 逐次更新

#### 一期先予測

一期先予測の更新は次のように定まる：

\[
p(\mathbf{x}_t | \mathbf{y}_{1:t-1}) = \int p(\mathbf{x}_t | \mathbf{x}_{t-1}) p(\mathbf{x}_{t-1} | \mathbf{y}_{1:t-1}) d\mathbf{x}_{t-1}
\]

被積分関数に着目すると、時刻 \( t-1 \) でのフィルタ分布とシステムモデルの条件付き分布の積となっていることがわかる。今、時刻 \( t-1 \) でのフィルタ分布が

\[
\mathbf{x}_{t-1} | \mathbf{y}_{1:t-1} \sim N(\mathbf{x}_{t-1} | t-1, V_{t-1 | t-1})
\]

で与えられていたとする。ここで平均・共分散行列は確定値であることに注意する。すると、一期先予測分布は次のように導出できる：

\[
\mathbf{x}_t | \mathbf{y}_{1:t-1} \sim N(\mathbf{x}_t | t-1, V_{t | t-1})
\]

\[
\mathbf{x}_{t | t-1} = F_t \mathbf{x}_{t-1 | t-1}
\]

\[
V_{t | t-1} = F_t V_{t-1 | t-1} F_t' + G_t Q_t G_t'
\]

#### フィルタ

ベイズの定理から、フィルタ分布の式は次のように表される：

\[
p(\mathbf{x}_t | \mathbf{y}_{1:t}) = \frac{p(\mathbf{y}_t | \mathbf{x}_t) p(\mathbf{x}_t | \mathbf{y}_{1:t-1})}{\int p(\mathbf{y}_t | \mathbf{x}_t) p(\mathbf{x}_t | \mathbf{y}_{1:t-1}) d\mathbf{x}_t}
\]

として、観測モデルの条件付き分布と時刻 \( t-1 \) での一期先予測分布の積に比例する形で書ける。今度は一期先予測分布が

\[
\mathbf{x}_{t | t-1} \sim N(\mathbf{x}_{t | t-1} | t-1, V_{t | t-1})
\]

として与えられているとすると、フィルタ分布は以下のガウス分布が得られる。

\[
\mathbf{x}_{t | t} \sim N(\mathbf{x}_{t | t}, V_{t | t})
\]

\[
K_t = V_{t | t-1} H_t' (H_t V_{t | t-1} H_t' + R_t)^{-1} \quad \text{(カルマンゲイン)}
\]

\[
\mathbf{x}_{t | t} = \mathbf{x}_{t | t-1} + K_t (\mathbf{y}_t - H_t \mathbf{x}_{t | t-1})
\]

\[
V_{t | t} = V_{t | t-1} - K_t H_t V_{t | t-1}
\]

フィルタ分布のパラメータ更新は新たな観測 \( \mathbf{y}_t \) による予測分布のパラメータのアジャストを意味する。カルマンゲインの果たす役割として、

- 残差 \( (\mathbf{y}_t - H_t \mathbf{x}_{t | t-1}) \) を平均の更新に反映する。
- 共分散行列を \( I - K_t H_t \) 倍に縮小する。

がある。

以上をまとめたものが次のアルゴリズムである。

### Algorithm (Kalman Filter)

【初期条件】初期値 \( \mathbf{x}_{0 | 0}, V_{0 | 0} \) を与える。

\( t = 1, \ldots, T \) に対して、次を行う。

#### 一期先予測

\[
\mathbf{x}_{t | t-1} = F_t \mathbf{x}_{t-1 | t-1}
\]

\[
V_{t | t-1} = F_t V_{t-1 | t-1} F_t' + G_t Q_t G_t'
\]

#### フィルタ

\[
K_t = V_{t | t-1} H_t' (H_t V_{t | t-1} H_t' + R_t)^{-1}
\]

\[
\mathbf{x}_{t | t} = \mathbf{x}_{t | t-1} + K_t (\mathbf{y}_t - H_t \mathbf{x}_{t | t-1})
\]

\[
V_{t | t} = V_{t | t-1} - K_t H_t V_{t | t-1}
\]



